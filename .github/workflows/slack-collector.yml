name: Slack Live Sync

on:
  repository_dispatch:
    types: [slack-message]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: slack-sync
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd scripts
          npm install

      - name: Save data.js before
        run: cp data.js data.js.before

      - name: Fetch Slack Messages
        run: node scripts/slack-to-datajs.js --limit=10
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Check diff and build summary
        id: diff
        run: |
          if diff -q data.js data.js.before > /dev/null 2>&1; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            
            # ìƒˆë¡œ ì¶”ê°€ëœ í•­ëª©ì—ì„œ title, type, location ì¶”ì¶œ
            TITLES=$(diff data.js.before data.js | grep "^>" | grep "title:" | sed 's/^>.*title: "//' | sed 's/",$//' | head -5)
            TYPES=$(diff data.js.before data.js | grep "^>" | grep "type:" | sed 's/^>.*type: "//' | sed 's/",$//' | head -5)
            LOCATIONS=$(diff data.js.before data.js | grep "^>" | grep "location:" | sed 's/^>.*location: "//' | sed 's/"$//' | head -5)
            
            SUMMARY=""
            i=1
            while IFS= read -r title; do
              type=$(echo "$TYPES" | sed -n "${i}p")
              location=$(echo "$LOCATIONS" | sed -n "${i}p")
              type_upper=$(echo "$type" | tr '[:lower:]' '[:upper:]')
              SUMMARY="${SUMMARY}â€¢ [${type_upper}] ${title} (${location})\n"
              i=$((i+1))
            done <<< "$TITLES"
            
            EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
            echo "summary<<$EOF" >> $GITHUB_OUTPUT
            echo -e "$SUMMARY" >> $GITHUB_OUTPUT
            echo "$EOF" >> $GITHUB_OUTPUT
          fi
          
          rm -f data.js.before

      - name: Commit and push changes
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "Slack Sync Bot"
          git config user.email "bot@autonomousship.org"
          git add data.js
          git diff --staged --quiet || git commit -m "âš¡ Slack sync: $(date +'%Y-%m-%d %H:%M')"
          git push

      - name: Notify Slack - success
        if: steps.diff.outputs.changed == 'true'
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âœ… *Maritime Hub ì—…ë°ì´íŠ¸ ì™„ë£Œ*\n\n${{ steps.diff.outputs.summary }}\nğŸ”— https://autonomousship.org\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack - no updates
        if: steps.diff.outputs.changed != 'true'
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"â„¹ï¸ Slack Sync ì‹¤í–‰ â€” ìƒˆë¡œìš´ ì†Œì‹ ì—†ìŒ"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
